jQuery(document).ready(function(){if(jQuery(".zp-Zotpress-Bib").length>0){var zp_collections={};var zp_totalItems=0;jQuery(".zp-Zotpress-Bib").each(function(index,instance){var $instance=jQuery(instance);var zp_params={};zp_params.zpItemkey=false;if(jQuery(".ZP_ITEM_KEY",$instance).text().trim().length>0)zp_params.zpItemkey=jQuery(".ZP_ITEM_KEY",$instance).text();zp_params.zpItemType=false;if(jQuery(".ZP_ITEMTYPE",$instance).text().trim().length>0)zp_params.zpItemType=jQuery(".ZP_ITEMTYPE",$instance).text();zp_params.zpCollectionId=false;if(jQuery(".ZP_COLLECTION_ID",$instance).text().trim().length>0)zp_params.zpCollectionId=jQuery(".ZP_COLLECTION_ID",$instance).text();zp_params.zpTagId=false;if(jQuery(".ZP_TAG_ID",$instance).text().trim().length>0)zp_params.zpTagId=jQuery(".ZP_TAG_ID",$instance).text();zp_params.zpAuthor=false;if(jQuery(".ZP_AUTHOR",$instance).text().trim().length>0)zp_params.zpAuthor=jQuery(".ZP_AUTHOR",$instance).text();zp_params.zpYear=false;if(jQuery(".ZP_YEAR",$instance).text().trim().length>0)zp_params.zpYear=jQuery(".ZP_YEAR",$instance).text();zp_params.zpStyle=false;if(jQuery(".ZP_STYLE",$instance).text().trim().length>0)zp_params.zpStyle=jQuery(".ZP_STYLE",$instance).text();zp_params.zpLimit=false;if(jQuery(".ZP_LIMIT",$instance).text().trim().length>0)zp_params.zpLimit=jQuery(".ZP_LIMIT",$instance).text();zp_params.zpTitle=false;if(jQuery(".ZP_TITLE",$instance).text().trim().length>0)zp_params.zpTitle=jQuery(".ZP_TITLE",$instance).text();zp_params.zpShowImages=false;if(jQuery(".ZP_SHOWIMAGE",$instance).text().trim().length>0)zp_params.zpShowImages=jQuery(".ZP_SHOWIMAGE",$instance).text().trim();zp_params.zpShowTags=false;if(jQuery(".ZP_SHOWTAGS",$instance).text().trim().length>0)zp_params.zpShowTags=true;zp_params.zpDownloadable=false;if(jQuery(".ZP_DOWNLOADABLE",$instance).text().trim().length>0)zp_params.zpDownloadable=true;zp_params.zpInclusive=false;if(jQuery(".ZP_INCLUSIVE",$instance).text().trim().length>0)zp_params.zpInclusive=true;zp_params.zpShowNotes=false;if(jQuery(".ZP_NOTES",$instance).text().trim().length>0)zp_params.zpShowNotes=true;zp_params.zpShowAbstracts=false;if(jQuery(".ZP_ABSTRACT",$instance).text().trim().length>0)zp_params.zpShowAbstracts=true;zp_params.zpCiteable=false;if(jQuery(".ZP_CITEABLE",$instance).text().trim().length>0)zp_params.zpCiteable=true;zp_params.zpTarget=false;if(jQuery(".ZP_TARGET",$instance).text().trim().length>0)zp_params.zpTarget=true;zp_params.zpURLWrap=false;if(jQuery(".ZP_URLWRAP",$instance).text().trim().length>0)zp_params.zpURLWrap=jQuery(".ZP_URLWRAP",$instance).text();zp_params.zpHighlight=false;if(jQuery(".ZP_HIGHLIGHT",$instance).text().trim().length>0)zp_params.zpHighlight=jQuery(".ZP_HIGHLIGHT",$instance).text();zp_params.zpUpdateNeeded=false;if(jQuery(".ZP_UPDATENEEDED",$instance).text().trim().length>0&&jQuery(".ZP_UPDATENEEDED",$instance).text()=="true")zp_params.zpUpdateNeeded=true;zp_params.zpJSON=false;if(jQuery(".ZP_JSON",$instance).text().trim().length>0)zp_params.zpJSON=jQuery(".ZP_JSON",$instance).text().trim();zp_params.zpForceNumsCount=1;zp_params.zpBibIndex=index;$fromScratch=true;if(!jQuery(".ZP_JSON",$instance).text().trim().length>0){$fromScratch=false}var zp_items=JSON.parse(decodeURIComponent(zp_params.zpJSON));zp_bib_reformat($instance,zp_items,zp_params);console.log("---");if(zp_params.zpCollectionId&&zp_params.zpCollectionId.indexOf(",")!=-1){zp_collections[index]=zp_params.zpCollectionId.split(",");zp_params.zpCollectionId=zp_collections[index][0];zp_get_items(0,0,$instance,zp_params,$fromScratch)}else{if(zp_params.zpTagId&&zp_params.zpInclusive==true&&zp_params.zpTagId.indexOf(",")!=-1){var tempTags=zp_params.zpTagId.split(",");jQuery.each(tempTags,function(i,tag){zp_params.zpTagId=tag;zp_get_items(0,0,$instance,zp_params,$fromScratch)})}else{if(zp_params.zpAuthor&&zp_params.zpAuthor.indexOf(",")!=-1){var tempAuthors=zp_params.zpAuthor.split(",");if(zp_params.zpInclusive==true){jQuery.each(tempAuthors,function(i,author){zp_params.zpAuthor=author;zp_get_items(0,0,$instance,zp_params,$fromScratch)})}else{zp_get_items(0,0,$instance,zp_params,$fromScratch)}}else{if(zp_params.zpYear&&zp_params.zpYear.indexOf(",")!=-1){var tempYears=zp_params.zpYear.split(",");jQuery.each(tempYears,function(i,year){zp_params.zpYear=year;zp_get_items(0,0,$instance,zp_params,$fromScratch)})}else{zp_get_items(0,0,$instance,zp_params,$fromScratch)}}}}})}function zp_get_items(request_start,request_last,$instance,params,update){console.log("zp: calling zp_get_items with update check?",update);console.log("zp: is an update needed?",params.zpUpdateNeeded);if(typeof request_start==="undefined"||request_start=="false"||request_start=="")request_start=0;if(typeof request_last==="undefined"||request_last=="false"||request_last=="")request_last=0;jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:true,data:{action:"zpRetrieveViaShortcode",instance_id:$instance.attr("id"),api_user_id:jQuery(".ZP_API_USER_ID",$instance).text(),item_type:jQuery(".ZP_ITEM_TYPE",$instance).text(),item_key:params.zpItemkey,itemtype:params.zpItemType,collection_id:params.zpCollectionId,tag_id:params.zpTagId,author:params.zpAuthor,year:params.zpYear,style:params.zpStyle,limit:params.zpLimit,title:params.zpTitle,showimage:params.zpShowImages,showtags:params.zpShowTags,downloadable:params.zpDownloadable,inclusive:params.zpInclusive,shownotes:params.zpShowNotes,showabstracts:params.zpShowAbstracts,citeable:params.zpCiteable,target:params.zpTarget,urlwrap:params.zpURLWrap,highlight:params.zpHighlight,sortby:jQuery(".ZP_SORTBY",$instance).text(),order:jQuery(".ZP_ORDER",$instance).text(),update:update,request_update:params.zpUpdateNeeded,request_start:request_start,request_last:request_last,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:true},success:function(data){if(!data||data.trim()===""){console.log("zp: Empty bib response received");jQuery(".zp-Zotpress-Bib",$instance).removeClass("loading");jQuery(".zp-Zotpress-Bib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-Bib",$instance).append("<p>No data received from server</p>\n");return}var zp_items;try{zp_items=jQuery.parseJSON(data)}catch(e){console.log("zp: Bib JSON parsing error:",e);console.log("zp: Raw bib response data:",data);console.log("zp: Response length:",data.length);console.log("zp: Response preview:",data.substring(0,200)+"...");jQuery(".zp-Zotpress-Bib",$instance).removeClass("loading");jQuery(".zp-Zotpress-Bib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-Bib",$instance).append("<p>Error loading bibliography: Invalid response from server</p>\n");return}if(zp_items.status=="error"||zp_items.status=="empty"||zp_items.data=="Not found"){var zp_msg=zpShortcodeAJAX.txt_zperror+" ";if(zp_items.data==0){zp_items.data=zpShortcodeAJAX.txt_noitemsfound;zp_msg=zp_items.data}else{zp_msg+=zp_items.data}console.log("zp: Zotpress message: "+zp_msg);var hideErrMsg="";if(jQuery("#"+zp_items.instance+" .zp-List .zp-Entry").length>0)hideErrMsg=' class="hide"';jQuery("#"+zp_items.instance+" .zp-List").removeClass("loading").append("<p"+hideErrMsg+">"+zp_msg+"</p>")}else{if(!zp_items.data||!Array.isArray(zp_items.data)){console.log("zp: Invalid data format - expected array, got:",typeof zp_items.data);jQuery(".zp-Zotpress-Bib",$instance).removeClass("loading");jQuery(".zp-Zotpress-Bib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-Bib",$instance).append("<p>Error: Invalid data format from server</p>\n");return}jQuery.each(zp_items.data,function(i,ic){if(ic&&ic.bib){var ic_decode=(new DOMParser).parseFromString(ic.bib,"text/html");zp_items.data[i].bib=ic_decode.documentElement.textContent}});zp_totalItems+=zp_items.data.length;if(update)console.log("zp: running update for items:",zp_totalItems,"->",zp_items.data.length);else console.log("zp: adding items:",zp_totalItems,"->",zp_items.data.length);jQuery("#"+zp_items.instance+" .zp-SEO-Content").remove();if(typeof zp_items!="undefined"&&zp_items!=null&&zp_items!=0&&zp_items.data.length>0){var tempItems="";if(params.zpShowNotes==true)var tempNotes="";if(update===false){jQuery("#"+zp_items.instance+" .zp-List").addClass("used_cache")}else if(update===true){if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating")&&jQuery("#"+zp_items.instance+" .zp-Citation-Notes").length>0)jQuery("#"+zp_items.instance+" .zp-Citation-Notes").remove();if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating"))jQuery("#"+zp_items.instance+" .zp-List").addClass("updating");params.zpForceNumsCount=1}if(zp_items.data!=0){jQuery.each(zp_items.data,function(index,item){var tempItem="";var $item_ref=jQuery("#"+zp_items.instance+" .zp-List #zp-ID-"+jQuery(".ZP_POSTID",$instance).text()+"-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+item.key);if($item_ref.length>0&&update===false&&!jQuery("#"+zp_items.instance+" .zp-List").hasClass("used_cache"))return false;var tempItemType="none";if(item.data.hasOwnProperty("itemType"))tempItemType=item.data.itemType;var tempItemYear="0000";var tempItemDate="0000";if(item.meta.hasOwnProperty("parsedDate")){tempItemYear=item.meta.parsedDate.substring(0,4);tempItemDate=item.meta.parsedDate}var tempAuthor=item.data.title;if(item.meta.hasOwnProperty("creatorSummary"))tempAuthor=item.meta.creatorSummary.replace(/ /g,"-");tempItem+="<div id='zp-ID-"+jQuery(".ZP_POSTID",$instance).text()+"-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+item.key+"'";tempItem+=" data-zp-author-date='"+tempAuthor+"-"+tempItemDate+"'";tempItem+=" data-zp-date-author='"+tempItemDate+"-"+tempAuthor+"'";tempItem+=" data-zp-date='"+tempItemDate+"'";tempItem+=" data-zp-year='"+tempItemYear+"'";tempItem+=" data-zp-itemtype='"+tempItemType+"'";tempItem+=" class='zp-Entry zpSearchResultsItem";if(update===true)tempItem+=" zp_updated";if(jQuery("#"+zp_items.instance+" .ZP_SHOWIMAGE").text().trim().length>0&&item.hasOwnProperty("image")){tempItem+=" zp-HasImage'>\n";tempItem+="<div id='zp-Citation-"+item.key+"' class='zp-Entry-Image hasImage' rel='"+item.key+"'>\n";if(params.zpURLWrap=="image"&&item.data.url!=""){tempItem+="<a href='"+item.data.url+"'";if(params.zpTarget)tempItem+=" target='_blank'";tempItem+=">"}tempItem+="<img class='thumb' src='"+item.image[0]+"' alt='image' />\n";if(params.zpURLWrap=="image"&&item.data.url!="")tempItem+="</a>";tempItem+="</div>\n"}else{tempItem+="'>\n"}if(jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text().length>0&&jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text()=="1"){if(!/csl-left-margin/i.test(item.bib)){item.bib=item.bib.replace('<div class="csl-entry">','<div class="csl-entry">'+params.zpForceNumsCount+". ");params.zpForceNumsCount++}}tempItem+=item.bib;if(params.zpShowAbstracts==true&&(item.data.hasOwnProperty("abstractNote")&&item.data.abstractNote.length>0))tempItem+="<p class='zp-Abstract'><span class='zp-Abstract-Title'>Abstract:</span> "+item.data.abstractNote+"</p>\n";if(params.zpShowTags==true&&(item.data.hasOwnProperty("tags")&&item.data.tags.length>0)){tempItem+="<p class='zp-Zotpress-ShowTags'><span class='title'>Tags:</span> ";jQuery.each(item.data.tags,function(tindex,tag){tempItem+="<span class='tag'>"+tag.tag+"</span>";if(tindex!=item.data.tags.length-1)tempItem+="<span class='separator'>,</span> "});tempItem+="</p>\n"}tempItem+="</div>\n";if(params.zpShowNotes==true&&item.hasOwnProperty("notes"))tempNotes+=item.notes;if($item_ref.length>0&&update===true)$item_ref.replaceWith(jQuery(tempItem));else tempItems+=tempItem})}jQuery("#"+zp_items.instance+" .zp-List").append(tempItems);if(params.zpShowNotes==true&&tempNotes.length>0){tempNotes="<div class='zp-Citation-Notes'>\n<h4>Notes</h4>\n<ol>\n"+tempNotes;tempNotes=tempNotes+"</ol>\n</div>\x3c!-- .zp-Citation-Notes --\x3e\n\n";jQuery("#"+zp_items.instance).append(tempNotes)}if(jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").length>0&&(jQuery(".ZP_STYLE",$instance).text().trim().length>0&&jQuery(".ZP_STYLE",$instance).text().trim()!="american-antiquity")){params.zpForceNumsCount=1;jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").each(function(index,item){var item_content=jQuery(item).text();item_content=item_content.replace(item_content.match(/\d+/)[0],params.zpForceNumsCount);jQuery(item).text(item_content);params.zpForceNumsCount++})}zp_bib_reformat($instance,zp_items,params);if(zp_items.meta.request_next!=false&&zp_items.meta.request_next!="false"){zp_get_items(zp_items.meta.request_next,zp_items.meta.request_last,$instance,params,update)}else{jQuery("#"+zp_items.instance+" .zp-List").removeClass("loading");if(zp_items.updateneeded){console.log("zp: update needed");params.zpUpdateNeeded=true;zp_get_items(0,0,$instance,params,true)}else{if(zp_collections[params.zpBibIndex]&&zp_collections[params.zpBibIndex].length>0&&zp_collections[params.zpBibIndex][zp_collections[params.zpBibIndex].length-1]!=params.zpCollectionId){params.zpCollectionId=zp_collections[params.zpBibIndex][zp_collections[params.zpBibIndex].indexOf(params.zpCollectionId)+1];jQuery("#"+zp_items.instance+" .zp-List").removeClass("updating");zp_get_items(0,0,$instance,params,update)}else{console.log("zp: done");console.log("---");jQuery("#"+zp_items.instance+" .zp-List").addClass("done-updating")}}}}else{console.log("zp: done");if(update===true){jQuery("#"+$instance.attr("id")+" .zp-List").removeClass("loading");if(jQuery("#"+$instance.attr("id")+" .zp-List .zp-Entry").length==0)jQuery("#"+$instance.attr("id")+" .zp-List").append("<p>There are no citations to display.</p>\n")}}}},error:function(errorThrown){console.log("zp: Zotpress via WP AJAX Error: ",errorThrown)}})}function zp_bib_reformat($instance,zp_items,zp_params){console.log("zp: reformatting instance",zp_items.instance);var sortby=jQuery(".ZP_SORTBY",$instance).text();var orderby=jQuery(".ZP_ORDER",$instance).text();var sortOrder="data-zp-author-date";if(sortby=="date")sortOrder="data-zp-date-author";typicalSort(zp_items,sortby,sortOrder,orderby);if(zp_params.zpTitle!==false){var titleSortedEntries={};jQuery("#"+zp_items.instance+" .zp-List div.zp-Entry").each(function(i,entry){var titleSortType=jQuery(entry).data("zp-"+zp_params.zpTitle);if(titleSortedEntries.hasOwnProperty(titleSortType)===false)titleSortedEntries[titleSortType]=[];titleSortedEntries[titleSortType].push(jQuery(entry).attr("id"))});var titleSortedEntriesOrder=Object.getOwnPropertyNames(titleSortedEntries);if(zp_params.zpTitle=="itemtype"){var orderedTypes=["book","bookSection","journalArticle","conferencePaper","thesis","report","encyclopediaArticle","newspaperArticle","magazineArticle","presentation","interview","dictionaryEntry","document","manuscript","patent","map","blogPost","webpage","artwork","film","audioRecording","statute","bill","case","hearing","forumPost","letter","email","instantMessage","software","podcast","radioBroadcast","tvBroadcast","videoRecording","attachment","note","preprint"];orderedTypes.slice(0).forEach(function(orderedType,i){if(titleSortedEntriesOrder.indexOf(orderedType)==-1)orderedTypes.splice(orderedTypes.indexOf(orderedType),1)});titleSortedEntriesOrder=orderedTypes}else{if(orderby=="asc")titleSortedEntriesOrder.sort(function(a,b){return a-b});else titleSortedEntriesOrder.sort(function(a,b){return b-a})}titleSortedEntriesOrder.forEach(function(orderedType,i){var tempTitle=orderedType;if(zp_params.zpTitle=="itemtype"){if(tempTitle.match(/[A-Z]/)!==null){var tempPos=tempTitle.match(/[A-Z]/).index;tempTitle=tempTitle.substr(0,tempPos)+" "+tempTitle.substr(tempPos)}tempTitle=tempTitle.charAt(0).toUpperCase()+tempTitle.slice(1)}if(tempTitle=="0000")tempTitle="No date";if(zp_params.zpTitle=="year"){if(jQuery("#"+$instance.attr("id")+" .zp-List h3[rel='"+orderedType+"']").length==0)jQuery("#"+$instance.attr("id")+" .zp-List").append("<h3 rel='"+orderedType+"'>"+tempTitle+"</h3>\n")}else if(jQuery("#"+$instance.attr("id")+" .zp-List h3[rel='"+orderedType+"']").length==0){jQuery("#"+$instance.attr("id")+" .zp-List").append("<h3 rel='"+orderedType+"'>"+tempTitle+"</h3>\n")}if(zp_params.zpTitle=="year"&&orderby=="asc")titleSortedEntries[orderedType].reverse();else if(zp_params.zpTitle=="itemtype"&&sortby=="date")titleSortedEntries[orderedType].reverse();titleSortedEntries[orderedType].forEach(function(entryID,i){jQuery("#"+$instance.attr("id")+" #"+entryID).insertAfter(jQuery("#"+$instance.attr("id")+" .zp-List h3[rel='"+orderedType+"']"))})})}}function typicalSort(zp_items,sortby,sortOrder,orderby){console.log("zp: running typical sort for instance ",zp_items.instance);if(["author","date"].indexOf(sortby)!==-1&&jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").length==0){jQuery("#"+zp_items.instance+" .zp-List div.zp-Entry").sort(function(a,b){var an=a.getAttribute(sortOrder).toLowerCase(),bn=b.getAttribute(sortOrder).toLowerCase();if(an>bn)if(orderby=="asc")return 1;else return-1;else if(an<bn)if(orderby=="asc")return-1;else return 1;else return 0}).detach().appendTo("#"+zp_items.instance+" .zp-List")}}});