jQuery(document).ready(function(){if(jQuery(".zp-Zotpress-InTextBib").length>0){var zp_totalItems=0;window.zpIntextCitations={};window.zpIntextCitationCount={};jQuery(".zp-Zotpress-InTextBib").each(function(index,instance){var $instance=jQuery(instance);var zp_params={};window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()]={};zp_params.zpItemkey=false;if(jQuery(".ZP_ITEM_KEY",$instance).text().trim().length>0)zp_params.zpItemkey=jQuery(".ZP_ITEM_KEY",$instance).text();zp_params.zpStyle=false;if(jQuery(".ZP_STYLE",$instance).text().trim().length>0)zp_params.zpStyle=jQuery(".ZP_STYLE",$instance).text();zp_params.zpTitle=false;if(jQuery(".ZP_TITLE",$instance).text().trim().length>0&&jQuery(".ZP_TITLE",$instance).text().trim()!="no")zp_params.zpTitle=jQuery(".ZP_TITLE",$instance).text();zp_params.zpShowImages=false;if(jQuery(".ZP_SHOWIMAGE",$instance).text().trim().length>0)zp_params.zpShowImages=jQuery(".ZP_SHOWIMAGE",$instance).text().trim();zp_params.zpShowTags=false;if(jQuery(".ZP_SHOWTAGS",$instance).text().trim().length>0)zp_params.zpShowTags=true;zp_params.zpDownloadable=false;if(jQuery(".ZP_DOWNLOADABLE",$instance).text().trim().length>0)zp_params.zpDownloadable=true;zp_params.zpShowNotes=false;if(jQuery(".ZP_NOTES",$instance).text().trim().length>0)zp_params.zpShowNotes=true;zp_params.zpShowAbstracts=false;if(jQuery(".ZP_ABSTRACT",$instance).text().trim().length>0)zp_params.zpShowAbstracts=true;zp_params.zpCiteable=false;if(jQuery(".ZP_CITEABLE",$instance).text().trim().length>0)zp_params.zpCiteable=true;zp_params.zpTarget=false;if(jQuery(".ZP_TARGET",$instance).text().trim().length>0)zp_params.zpTarget=true;zp_params.zpURLWrap=false;if(jQuery(".ZP_URLWRAP",$instance).text().trim().length>0)zp_params.zpURLWrap=jQuery(".ZP_URLWRAP",$instance).text();zp_params.zpHighlight=false;if(jQuery(".ZP_HIGHLIGHT",$instance).text().trim().length>0)zp_params.zpHighlight=jQuery(".ZP_HIGHLIGHT",$instance).text();zp_params.zpSortBy=false;if(jQuery(".ZP_SORTBY",$instance).text().trim().length>0)zp_params.zpSortBy=jQuery(".ZP_SORTBY",$instance).text();zp_params.zpOrder=false;if(jQuery(".ZP_ORDER",$instance).text().trim().length>0)zp_params.zpOrder=jQuery(".ZP_ORDER",$instance).text();zp_params.zpUpdateNeeded=false;if(jQuery(".ZP_UPDATENEEDED",$instance).text().trim().length>0&&jQuery(".ZP_UPDATENEEDED",$instance).text()=="true")zp_params.zpUpdateNeeded=true;zp_params.zpJSON=false;if(jQuery(".ZP_JSON",$instance).text().trim().length>0)zp_params.zpJSON=jQuery(".ZP_JSON",$instance).text().trim();if(jQuery(".ZP_JSON",$instance).text().trim().length>0){var zp_items=JSON.parse(decodeURIComponent(zp_params.zpJSON));zp_process_intext($instance,zp_params.zpItemkey,zp_items,zp_params,false)}else{zp_get_items(0,0,$instance,zp_params,false)}})}function zp_get_items(request_start,request_last,$instance,params,update){console.log("zp: calling zp_get_items with update check?",update);console.log("zp: is an update needed?",params.zpUpdateNeeded);if(typeof request_start==="undefined"||request_start=="false"||request_start=="")request_start=0;if(typeof request_last==="undefined"||request_last=="false"||request_last=="")request_last=0;jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:true,data:{action:"zpRetrieveViaShortcode",instance_id:$instance.attr("id"),type:"intext",item_key:params.zpItemkey,style:params.zpStyle,title:params.zpTitle,showimage:params.zpShowImages,showtags:params.zpShowTags,downloadable:params.zpDownloadable,shownotes:params.zpShowNotes,showabstracts:params.zpShowAbstracts,citeable:params.zpCiteable,target:params.zpTarget,urlwrap:params.zpURLWrap,highlight:params.zpHighlight,sortby:params.zpSortBy,order:params.zpOrder,update:update,request_update:params.zpUpdateNeeded,request_start:request_start,request_last:request_last,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:true},success:function(data){if(!data||data.trim()===""){console.log("zp: Empty intext response received");jQuery(".zp-Zotpress-InTextBib",$instance).removeClass("loading");jQuery(".zp-Zotpress-InTextBib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-InTextBib",$instance).append("<p>No data received from server</p>\n");return}var zp_items;try{zp_items=jQuery.parseJSON(data)}catch(e){console.log("zp: InText JSON parsing error:",e);console.log("zp: Raw intext response data:",data);console.log("zp: Response length:",data.length);console.log("zp: Response preview:",data.substring(0,200)+"...");jQuery(".zp-Zotpress-InTextBib",$instance).removeClass("loading");jQuery(".zp-Zotpress-InTextBib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-InTextBib",$instance).append("<p>Error loading intext citations: Invalid response from server</p>\n");return}if(zp_items.status==="error"){console.log("zp: Server returned error:",zp_items.data);jQuery(".zp-Zotpress-InTextBib",$instance).removeClass("loading");jQuery(".zp-Zotpress-InTextBib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-InTextBib",$instance).append("<p>Error: "+zp_items.data+"</p>\n");return}if(zp_items.status==="empty"){console.log("zp: No items found");jQuery(".zp-Zotpress-InTextBib",$instance).removeClass("loading");jQuery(".zp-Zotpress-InTextBib",$instance).find(".zp_display_progress").remove();jQuery(".zp-Zotpress-InTextBib",$instance).append("<p>No items found</p>\n");return}if(zp_items.data&&Array.isArray(zp_items.data)){jQuery.each(zp_items.data,function(i,ic){var ic_decode=(new DOMParser).parseFromString(ic.bib,"text/html");zp_items.data[i].bib=ic_decode.documentElement.textContent})}zp_totalItems+=zp_items.data.length;if(update)console.log("zp: running update for items:",zp_totalItems,"->",zp_items.data.length);else console.log("zp: adding items:",zp_totalItems,"->",zp_items.data.length);zp_process_intext($instance,params.zpItemkey,zp_items,params,update)},error:function(errorThrown){console.log("zp: Zotpress Error:"+errorThrown)}})}function zp_process_intext($instance,item_keys,zp_items,params,update){if(zp_items===false||zp_items.status=="error"){console.log("zp: Zotpress Error: "+zp_items.data);var hideErrMsg="";if(jQuery("#"+zp_items.instance+" .zp-List .zp-Entry").length>0)hideErrMsg=' class="hide"';jQuery("#"+zp_items.instance+" .zp-List").removeClass("loading").append("<p"+hideErrMsg+">Zotpress Error: "+zp_items.data+"</p>")}else{if(typeof zp_items!="undefined"&&zp_items!=null&&parseInt(zp_items)!=0&&zp_items.data.length>0){if(params.zpShowNotes==true)var tempNotes="";var $postRef=jQuery($instance).parent();if(update===false){jQuery("#"+zp_items.instance+" .zp-List").addClass("used_cache")}else if(update===true){if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating")&&jQuery("#"+zp_items.instance+" .zp-Citation-Notes").length>0)jQuery("#"+zp_items.instance+" .zp-Citation-Notes").remove();if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating"))jQuery("#"+zp_items.instance+" .zp-List").addClass("updating")}zp_format_intext_citations($instance,params.zpItemkey,zp_items.data,params,update);tempNotes=zp_format_intextbib($instance,zp_items,params.zpItemkey,params,update);if(update===false){jQuery("#"+zp_items.instance+" .zp-SEO-Content .zp-Entry").unwrap()}if(params.zpShowNotes==true&&tempNotes.length>0){tempNotes="<div class='zp-Citation-Notes'>\n<h4>Notes</h4>\n<ol>\n"+tempNotes;tempNotes=tempNotes+"</ol>\n</div>\x3c!-- .zp-Citation-Notes --\x3e\n\n";jQuery("#"+zp_items.instance).append(tempNotes)}if(zp_items.meta.request_next!=false&&zp_items.meta.request_next!="false"){zp_get_items(zp_items.meta.request_next,zp_items.meta.request_last,$instance,params,update)}else{jQuery("#"+zp_items.instance+" .zp-List").removeClass("loading");if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating")){zp_get_items(0,0,$instance,params,true)}else{if(zp_items.updateneeded){console.log("zp: update needed");params.zpUpdateNeeded=true;zp_get_items(0,0,$instance,params,true)}else{var sortby=params.zpSortBy;var orderby=params.zpOrder;if(["author","date"].indexOf(sortby)!==-1&&jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").length==0){var sortOrder="zp-author-date";if(sortby=="date")sortOrder="zp-date-author";jQuery("#"+zp_items.instance+" .zp-List div.zp-Entry").sort(function(a,b){var an=jQuery(a).data(sortOrder).toLowerCase(),bn=jQuery(b).data(sortOrder).toLowerCase();if(an>bn)if(orderby=="asc")return 1;else return-1;else if(an<bn)if(orderby=="asc")return-1;else return 1;else return 0}).detach().appendTo("#"+zp_items.instance+" .zp-List")}else if(["author","date"].indexOf(sortby)==-1&&jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").length!=0){console.log("zp: re-sorting numbered citations in bibliography");jQuery("#"+zp_items.instance+" .zp-List div.zp-Entry").sort(function(a,b){var an=parseInt(jQuery(".csl-left-margin",a).text()),bn=parseInt(jQuery(".csl-left-margin",b).text());if(an>bn)if(orderby=="asc")return 1;else return-1;else if(an<bn)if(orderby=="asc")return-1;else return 1;else return 0}).detach().appendTo("#"+zp_items.instance+" .zp-List")}console.log("zp: done");console.log("---")}}}}else{console.log("zp: no items");console.log("---");var tempPost=$instance.attr("class");tempPost=tempPost.replace("zp-Zotpress zp-Zotpress-InTextBib zp-Post-","");if(jQuery("#post-"+tempPost).length>0)jQuery("#post-"+tempPost+" .zp-InText-Citation").removeClass("loading").remove();else jQuery("#"+$instance.attr("id")).parent().find(".zp-InText-Citation").removeClass("loading").remove();jQuery("#"+$instance.attr("id")+" .zp-List").removeClass("loading");jQuery("#"+$instance.attr("id")+" .zp-List").append("<p>There are no citations to display.</p>\n")}}}function zp_format_intext_citations($instance,item_keys,item_data,params,update){var intext_citations=[];if(item_keys.indexOf(";")!=-1)intext_citations=item_keys.split(";");else intext_citations.push(item_keys);var tempItem_data={};jQuery.each(item_data,function(index,value){if(!tempItem_data.hasOwnProperty(value.key))tempItem_data[value.key]=value});item_data=tempItem_data;var intextGroupTracker={};jQuery.each(intext_citations,function(index,intext_citation){var intext_citation_output="";var $postRef=jQuery($instance).parent();var tempId=intext_citation.replace(/{/g,"-").replace(/}/g,"-").replace(/,/g,"_").replace(/:/g,"-");var intext_citation_id="zp-InText-zp-ID-"+tempId+"-wp"+jQuery(".ZP_POSTID",$instance).text();var intext_group_index=0;if(jQuery("."+intext_citation_id,$postRef).length>1)if(!intextGroupTracker.hasOwnProperty(intext_citation_id))intextGroupTracker[intext_citation_id]=0;else intext_group_index=intextGroupTracker[intext_citation_id];var intext_citation_params=JSON.parse(jQuery("."+intext_citation_id+":eq("+intext_group_index+")",$postRef).attr("rel").replace(/'/g,'"'));intext_citation_split=intext_citation.split("},{");intext_citation=new Array;jQuery.each(intext_citation_split,function(id,item){item_parts=item.split(":");item_pages=false;if(intext_citation_params.pages!="np"){item_pages=intext_citation_params.pages.replaceAll("++",", ");item_pages=item_pages.split("--")[id];if(item_pages=="np")item_pages=false}intext_citation[id]={api_user_id:item_parts[0].replace("{",""),key:item_parts[1].replace("}",""),post_id:jQuery(".ZP_POSTID",$instance).text(),pages:item_pages,class:intext_citation_id}});var group_authors=[];jQuery.each(intext_citation,function(cindex,item){var item_citation="";var item_authors="";var item_year="";if(!window.zpIntextCitations["post-"+item.post_id].hasOwnProperty(item.key)){window.zpIntextCitations["post-"+item.post_id][item.key]=item;if(typeof window.zpIntextCitationCount["post-"+item.post_id]==="undefined")window.zpIntextCitationCount["post-"+item.post_id]=0;window.zpIntextCitationCount["post-"+item.post_id]++;window.zpIntextCitations["post-"+item.post_id][item.key]["num"]=window.zpIntextCitationCount["post-"+item.post_id]}if(item_data.hasOwnProperty(item.key)){if(item_data[item.key].data.hasOwnProperty("creators")){var tempAuthorCount=0;var tempAuthorTypeExists=false;jQuery.each(item_data[item.key].data.creators,function(ai,author){if(author.creatorType=="author"){tempAuthorTypeExists=true;return false}});jQuery.each(item_data[item.key].data.creators,function(ai,author){if(tempAuthorTypeExists&&author.creatorType!="author")return true;tempAuthorCount++;if(ai!=0&&tempAuthorCount>1)item_authors+=", ";if(author.hasOwnProperty("name"))item_authors+=author.name;else if(author.hasOwnProperty("lastName"))item_authors+=author.lastName});if(group_authors.indexOf(item_authors)==-1)group_authors[group_authors.length]=item_authors;item_authors=item_authors.split(", ");if(jQuery.isArray(item_authors)&&item_authors.length>2){if(intext_citation_params.etal==""||intext_citation_params.etal=="default"){}else if(intext_citation_params.etal=="yes"){item_authors=item_authors[0]+" <em>et al.</em>"}}if(jQuery.isArray(item_authors)&&item_authors.length>1&&item_authors.indexOf("et al")==-1){var temp_and=" &amp; ";if(intext_citation_params.and=="and")temp_and=" and ";else if(intext_citation_params.and=="comma-and")temp_and=", and ";else if(intext_citation_params.and=="comma-amp")temp_and=", &amp; ";else if(intext_citation_params.and=="comma")temp_and=", ";else temp_and=" &amp; ";var temp=item_authors.join().replace(/,/g,", ");item_authors=temp.substring(0,temp.lastIndexOf(", "))+temp_and+item_authors[item_authors.length-1]}}else{item_authors+=item_data[item.key].data.title}if(item_data[item.key].meta.hasOwnProperty("parsedDate"))item_year=item_data[item.key].meta.parsedDate.substring(0,4);else item_year="n.d.";window.zpIntextCitations["post-"+item.post_id][item.key]["intexttitle"]="title='"+JSON.stringify(item_authors).replace("<em>et al.</em>","et al.").replace(/\"/g,"").replace("[","").replace("]","").replace(/â€™/g,"&#39;").replace(/'/g,"&#39;")+" ("+item_year+"). "+item_data[item.key].data.title+".' "}if(intext_citation_params.format.indexOf("%num%")!=-1){var default_format=intext_citation_params.format;var item_citation_num=window.zpIntextCitations["post-"+item.post_id][item.key]["num"];item_citation=intext_citation_params.format.replace("%num%",item_citation_num);if(item.pages!=false){var multip="p. ";if(item.pages.indexOf("-")!=-1)multip="pp. ";item_citation=item_citation.replace("%p%",multip+item.pages)}else{item_citation=item_citation.replace(", %p%","")}if(intext_citation.length>1){if(cindex!=intext_citation.length-1)item_citation=item_citation.replace(")","");if(cindex!=0)if(item_authors=="")item_citation=item_citation.replace("(, ","");else item_citation=item_citation.replace("(","")}if(intext_citation_params.brackets){item_citation=item_citation.replace("(","");item_citation=item_citation.replace(")","")}}else{var default_format=intext_citation_params.format;item_citation=intext_citation_params.format.replace("%a%",item_authors);item_citation=item_citation.replace("%d%",item_year);if(item.pages==false){item_citation=item_citation.replace(", %p%","");item_citation=item_citation.replace("%p%","")}else{item_citation=item_citation.replace("%p%",item.pages)}if((default_format=="(%a%, %d%, %p%)"||default_format=="(%a%, %d%)")&&intext_citation.length>1){if(cindex!=intext_citation.length-1)item_citation=item_citation.replace(")","");if(cindex!=0)if(item_authors=="")item_citation=item_citation.replace("(, ","");else item_citation=item_citation.replace("(","")}if((default_format=="%a%, %d%, %p%"||default_format=="%a%, %d%")&&intext_citation.length>1&&cindex!=0&&item_authors==""){item_citation=item_citation.replace(", ","")}}if(!window.zpIntextCitations["post-"+item.post_id][item.key].hasOwnProperty("intexttitle"))window.zpIntextCitations["post-"+item.post_id][item.key]["intexttitle"]="";item_citation="<a rel='"+item.key+"' "+window.zpIntextCitations["post-"+item.post_id][item.key]["intexttitle"]+"class='zp-ZotpressInText' href='#zp-ID-"+item.post_id+"-"+item.api_user_id+"-"+item.key+"'>"+item_citation+"</a>";if(intext_citation_params.format.indexOf("sup")!="-1")item_citation="<sup>"+item_citation+"</sup>";intext_citation[cindex]["intext"]=item_citation;intext_citation[cindex]["class"]=item.class;var tempItemDate="0000";var tempItemYear="0000";if(item_data[item.key].meta.hasOwnProperty("parsedDate")){tempItemDate=item_data[item.key].meta.parsedDate;tempItemYear=item_data[item.key].meta.parsedDate.substring(0,4)}var tempAuthor="";if(item_data[item.key].meta.hasOwnProperty("creatorSummary"))tempAuthor=item_data[item.key].meta.creatorSummary.replace(/['" ]/g,"-");intext_citation[cindex]["year"]=tempItemYear;intext_citation[cindex]["authdate"]=tempAuthor+"-"+tempItemDate});var intext_citation_pre="";if(intext_citation_params.brackets)intext_citation_pre="[";var intext_citation_post="";if(intext_citation_params.brackets)intext_citation_post="]";intext_citation_output=intext_citation_pre;jQuery.each(intext_citation,function(cindex,item){if(cindex!=0){if(intext_citation_params.separator=="comma")intext_citation_output+=", ";else intext_citation_output+="; "}intext_citation_output+=item.intext});intext_citation_output+=intext_citation_post;jQuery("."+intext_citation_id+":eq("+intext_group_index+")",$postRef).removeClass("loading").html(intext_citation_output);if(intextGroupTracker.hasOwnProperty(intext_citation_id))intextGroupTracker[intext_citation_id]++})}function zp_format_intextbib($instance,zp_items,zp_itemkeys,params,update){var tempNotes="";var tempHasNum=false;var zpPostID=jQuery(".ZP_POSTID",$instance).text();var itemNumOrderArr=[];var authDateArr=[];var authDateList={};var alphaArray=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];jQuery.each(zp_items.data,function(index,item){var tempItem="";var $item_ref=jQuery("#"+zp_items.instance+" .zp-List #zp-ID-"+zpPostID+"-"+item.library.id+"-"+item.key);var tempItemDate="0000";var tempItemYear="0000";if(item.meta.hasOwnProperty("parsedDate")){tempItemDate=item.meta.parsedDate;tempItemYear=item.meta.parsedDate.substring(0,4)}var tempAuthor="";if(item.meta.hasOwnProperty("creatorSummary"))tempAuthor=item.meta.creatorSummary.replace(/['" ]/g,"-");var tempTitleAbrv="";if(params.zpTitle){tempTitleAbrv=item.data.title.substr(10).replace(/['" ]/g,"-");tempItem+="<h3>"+tempItemYear+"</h3>\n"}var authDateStr=tempAuthor+"-"+tempItemDate;var authDateStrDisAlpha="";var authDateInstances=1;var flag=false;if(authDateArr.includes(authDateStr)){flag=true;authDateInstances=authDateArr.filter(v=>v===authDateStr).length;authDateStrDisAlpha=alphaArray[authDateInstances-1];authDateInstances+=1}authDateArr.push(authDateStr);authDateList[authDateStr+"-"+(authDateInstances-1)]={itemkey:item.key,authDateStrDisAlpha:authDateStrDisAlpha};tempItem+="<div id='zp-ID-"+jQuery(".ZP_POSTID",$instance).text()+"-"+item.library.id+"-"+item.key+"'";tempItem+=" data-zp-author-date='"+tempAuthor+"-"+tempItemDate+"'";tempItem+=" data-zp-date-author='"+tempItemDate+"-"+tempAuthor+"'";tempItem+=" class='zp-Entry zpSearchResultsItem zp-Num-"+window.zpIntextCitations["post-"+zpPostID][item.key]["num"];if(flag){if(authDateInstances==2){var tempPrevItemKey=authDateList[authDateStr+"-0"].itemkey;var tempPrevItem=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey];var tempItemYearDis=tempPrevItem.year+"b";window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey].intexttitle=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey].intexttitle.replaceAll(tempItemYear,tempItemYearDis);window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey].intext=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey].intext.replaceAll(tempItemYear,tempItemYearDis);jQuery.each(zp_items.data,function(bindex,bitem){if(bitem.key==tempPrevItemKey&&zp_items.data[bindex].bib.indexOf(tempItemYearDis)==-1){zp_items.data[bindex].bib=zp_items.data[bindex].bib.replace(tempItemYear,tempItemYearDis)}});jQuery("."+window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][tempPrevItemKey].class).each(function(){jQuery('a[rel="'+tempPrevItemKey+'"',this).text(jQuery('a[rel="'+tempPrevItemKey+'"',this).text().replaceAll(tempItemYear,tempItemYearDis));jQuery('a[rel="'+tempPrevItemKey+'"',this).attr("title",jQuery('a[rel="'+tempPrevItemKey+'"',this).attr("title").replaceAll(tempItemYear,tempItemYearDis))});var $tempEntry=jQuery("#zp-ID-"+zpPostID+"-"+item.library.id+"-"+tempPrevItemKey);var $tempCsl=jQuery("#zp-ID-"+zpPostID+"-"+item.library.id+"-"+tempPrevItemKey+" .csl-entry");if($tempCsl.html().indexOf(tempItemYearDis)==-1)$tempCsl.html($tempCsl.html().replace(tempItemYear,tempItemYearDis));$tempEntry.addClass("zp_disam").attr("data-zp-author-date",tempAuthor+"-"+tempItemYearDis).attr("data-zp-date-author",tempItemYearDis+"-"+tempAuthor)}var tempItemYearDis=tempItemYear+authDateStrDisAlpha;window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][item.key].intexttitle=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][item.key].intexttitle.replaceAll(tempItemYear,tempItemYearDis);window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][item.key].intext=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][item.key].intext.replaceAll(tempItemYear,tempItemYearDis);if(item.bib.indexOf(tempItemYearDis)==-1)item.bib=item.bib.replace(tempItemYear,tempItemYearDis);if(zp_items.data[index].bib.indexOf(tempItemYearDis)==-1)zp_items.data[index].bib=zp_items.data[index].bib.replace(tempItemYear,tempItemYearDis);jQuery("."+window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()][item.key].class).each(function(){jQuery('a[rel="'+item.key+'"',this).text(jQuery('a[rel="'+item.key+'"',this).text().replaceAll(tempItemYear,tempItemYearDis));jQuery('a[rel="'+item.key+'"',this).attr("title",jQuery('a[rel="'+item.key+'"',this).attr("title").replaceAll(tempItemYear,tempItemYearDis))});var $tempEntry=jQuery("#zp-ID-"+zpPostID+"-"+item.library.id+"-"+item.key);var $tempCsl=jQuery("#zp-ID-"+zpPostID+"-"+item.library.id+"-"+item.key+" .csl-entry");if($tempCsl.html()&&$tempCsl.html().indexOf(tempItemYearDis)==-1)$tempCsl.html($tempCsl.html().replace(tempItemYear,tempItemYearDis));$tempEntry.addClass("zp_disam").attr("data-zp-author-date",tempAuthor+"-"+tempItemYearDis).attr("data-zp-date-author",tempItemYearDis+"-"+tempAuthor)}if(update===true)tempItem+=" zp_updated";if(jQuery("#"+zp_items.instance+" .ZP_SHOWIMAGE").text().trim().length>0&&item.hasOwnProperty("image")){tempItem+=" zp-HasImage'>\n";tempItem+="<div id='zp-Citation-"+item.key+"' class='zp-Entry-Image hasImage' rel='"+item.key+"'>\n";if(params.zpURLWrap=="image"&&item.data.url!=""){tempItem+="<a href='"+item.data.url+"'";if(params.zpTarget)tempItem+=" target='_blank'";tempItem+=">"}tempItem+="<img class='thumb' src='"+item.image[0]+"' alt='image' />\n";if(params.zpURLWrap=="image"&&item.data.url!="")tempItem+="</a>";tempItem+="</div>\x3c!-- .zp-Entry-Image --\x3e\n"}else{tempItem+="'>\n"}var temp=zp_forcenumbers(zp_items.instance,item,zpPostID);item=temp.item;itemNumOrderArr[temp.itemNumOrder.order]=temp.itemNumOrder.key;if(/csl-left-margin/i.test(item.bib))tempHasNum=true;tempItem+=item.bib;if(params.zpShowAbstracts==true&&(item.data.hasOwnProperty("abstractNote")&&item.data.abstractNote.length>0))tempItem+="<p class='zp-Abstract'><span class='zp-Abstract-Title'>Abstract:</span> "+item.data.abstractNote+"</p>\n";if(params.zpShowTags==true&&(item.data.hasOwnProperty("tags")&&item.data.tags.length>0)){tempItem+="<p class='zp-Zotpress-ShowTags'><span class='title'>Tags:</span> ";jQuery.each(item.data.tags,function(tindex,tag){tempItem+="<span class='tag'>"+tag.tag+"</span>";if(tindex!=item.data.tags.length-1)tempItem+="<span class='separator'>,</span> "});tempItem+="</p>\n"}tempItem+="</div>\n";if(params.zpShowNotes==true&&item.hasOwnProperty("notes")){tempNotes+=item.notes}if($item_ref.length>0&&update===true){$item_ref.replaceWith(jQuery(tempItem))}else{if($item_ref.length==0){jQuery("#"+zp_items.instance+" .zp-List").append(tempItem)}else{$item_ref.replaceWith(jQuery(tempItem))}}});if(tempHasNum&&update===false){if(jQuery("#"+zp_items.instance+" .zp-List .zp-Entry").length==0){}else{for(var num=1;num<itemNumOrderArr.length;num++){var item=window.zpIntextCitations["post-"+zpPostID][itemNumOrderArr[num]];var $item=jQuery("#"+"zp-ID-"+zpPostID+"-"+window.zpIntextCitations["post-"+zpPostID][itemNumOrderArr[num]].api_user_id+"-"+itemNumOrderArr[num]);jQuery("#"+zp_items.instance+" .zp-List").append($item)}}}else{}return tempNotes}function zp_forcenumbers(zp_instance,zp_item,zpPostID){var itemNumOrder={order:0,item_key:""};if(/csl-left-margin/i.test(zp_item.bib)){var $item_content=jQuery.parseHTML(zp_item.bib);var item_num_content=jQuery(".csl-left-margin",$item_content).text();item_num_content=item_num_content.replace(item_num_content.match(/\d+/)[0],window.zpIntextCitations["post-"+zpPostID][zp_item.key]["num"]);jQuery(".csl-left-margin",$item_content).text(item_num_content);zp_item.bib=jQuery("<div>").append($item_content).html();itemNumOrder.order=window.zpIntextCitations["post-"+zpPostID][zp_item.key]["num"];itemNumOrder.key=zp_item.key}else{if(jQuery("#"+zp_instance+" .ZP_FORCENUM").text().length>0&&jQuery("#"+zp_instance+" .ZP_FORCENUM").text()=="1"){var $item_content=jQuery.parseHTML(zp_item.bib);jQuery(".csl-entry",$item_content).prepend('<div class="csl-left-margin" style="display: inline;">'+window.zpIntextCitations["post-"+zpPostID][zp_item.key]["num"]+". </div>");zp_item.bib=jQuery("<div>").append($item_content).html();itemNumOrder.order=window.zpIntextCitations["post-"+zpPostID][zp_item.key]["num"];itemNumOrder.key=zp_item.key}}return{itemNumOrder:itemNumOrder,item:zp_item}}});