jQuery(document).ready(function(){if(jQuery(".zp-Browse").length>0)for(let a=0;a<window.zpBrowseList.length;++a){var e=jQuery("#"+window.zpBrowseList[a].id),t={zpCollectionId:!1,zpTagId:!1,zpShowTags:!1,zpShowImages:!1,zpIsAdmin:!1,zpTarget:!1,zpTopLevel:!1,zpURLWrap:!1,zpItemsFlag:!0};jQuery(".ZP_COLLECTION_ID",e).length>0&&(t.zpCollectionId=jQuery(".ZP_COLLECTION_ID",e).text()),jQuery(".ZP_TAG_ID",e).length>0&&(t.zpTagId=jQuery(".ZP_TAG_ID",e).text()),jQuery(".ZP_SHOWTAGS").length>0&&"1"==parseInt(jQuery(".ZP_SHOWTAGS").text())&&(t.zpShowTags=!0),jQuery(".ZP_SHOWIMAGE",e).length>0&&("yes"==jQuery(".ZP_SHOWIMAGE",e).text()||"true"==jQuery(".ZP_SHOWIMAGE",e).text()||"1"==jQuery(".ZP_SHOWIMAGE",e).text())&&(t.zpShowImages=!0),jQuery(".ZP_ISADMIN",e).length>0&&(t.zpIsAdmin=!0),jQuery(".ZP_TARGET",e).length>0&&jQuery(".ZP_TARGET").text().length>0&&(t.zpTarget=!0),jQuery(".ZP_TOPLEVEL",e).length>0&&(t.zpTopLevel=jQuery(".ZP_TOPLEVEL",e).text(),!1===t.zpCollectionId&&!1===t.zpTagId&&(t.zpCollectionId=t.zpTopLevel)),jQuery(".ZP_URLWRAP",e).length>0&&(t.zpURLWrap=jQuery(".ZP_URLWRAP",e).text());var r=!1;jQuery(".ZP_UPDATENEEDED",e).text().trim().length>0&&"true"==jQuery(".ZP_UPDATENEEDED",e).text()&&(r=!0);var o=!0;""==jQuery(".ZP_BROWSEBAR",e).text()&&(o=!1),o&&(s(a,t,e,0,0,!1),l(a,t,e,0,0,!1)),n(a,t,e,0,0,!1),console.log("---")}function a(e){if(0!=jQuery("div.zp-List .csl-left-margin",e).length&&/\d/.test(jQuery("div.zp-List .csl-left-margin",e).text())){var t=1;jQuery("div.zp-List .csl-left-margin",e).each(function(){jQuery(this).text(jQuery(this).text().replace(/(\d+)/,t)),t++})}}function s(e,t,r,o,a,l){void 0!==o&&"false"!=o&&""!=o||(o=0),void 0!==a&&"false"!=a&&""!=a||(a=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",r).text(),item_type:"collections",collection_id:t.zpCollectionId,request_start:o,request_last:a,sortby:"title",get_top:!0,update:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(o){if(!o||""===o.trim())return console.log("zp: Empty collections response received"),void jQuery("select.zp-Browse-Collections-Select",r).removeClass("loading").find(".loading").remove();var a;try{a=jQuery.parseJSON(o)}catch(e){return console.log("zp: Collections JSON parsing error:",e),console.log("zp: Raw collections response data:",o),void jQuery("select.zp-Browse-Collections-Select",r).removeClass("loading").find(".loading").remove()}if("error"===a.status)return console.log("zp: Server returned error:",a.data),void jQuery("select.zp-Browse-Collections-Select",r).removeClass("loading").find(".loading").remove();if("empty"===a.status)return console.log("zp: No collections found"),void jQuery("select.zp-Browse-Collections-Select",r).removeClass("loading").find(".loading").remove();var n="";!1===l&&jQuery("select.zp-Browse-Collections-Select",r).addClass("used_cache"),!0!==l||jQuery("select.zp-Browse-Collections-Select",r).hasClass("updating")||(jQuery("select.zp-Browse-Collections-Select",r).find("*").not(".blank").remove(),jQuery("select.zp-Browse-Collections-Select",r).addClass("updating"),t.zpTagId&&jQuery("select.zp-Browse-Collections-Select",r).append("<option value='blank'>--"+zpShortcodeAJAX.txt_nocollsel+"--</option>")),t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.blank",r).length&&jQuery(".ZP_COLLECTION_NAME",r).length>0&&jQuery("select.zp-Browse-Collections-Select",r).append("<option value='blank' class='blank'>"+jQuery(".ZP_COLLECTION_NAME",r).text()+"</option>\n"),"0"!=a&&a.data&&Array.isArray(a.data)&&a.data.length>0&&"0"!=a.data&&(jQuery.each(a.data,function(e,r){var o="<option value='"+r.key+"'";t.zpCollectionId==r.key&&(o+=" selected='selected'"),o+=">",t.zpCollectionId&&(o+="- "),o+=r.data.name+" (",r.meta.numCollections>0&&(o+=r.meta.numCollections+" "+zpShortcodeAJAX.txt_subcoll+", "),o+=r.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",n+=o}),jQuery("select.zp-Browse-Collections-Select",r).append(n),0!=a.meta.request_next&&"false"!=a.meta.request_next?s(e,t,r,a.meta.request_next,a.meta.request_last,l):jQuery("select.zp-Browse-Collections-Select",r).hasClass("updating")||s(e,t,r,0,0,!0)),t.zpCollectionId&&"toplevel"!=t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.toplevel",r).length&&jQuery("select.zp-Browse-Collections-Select",r).append("<option value='toplevel' class='toplevel'>&larr; "+zpShortcodeAJAX.txt_backtotop+"</option>\n"),jQuery("select.zp-Browse-Collections-Select",r).removeClass("loading").find(".loading").remove()},error:function(e){console.log("zp: error for zplib_get_collections(): ",e.statusText)},complete:function(e,t){}})}function l(e,t,r,o,a,s){void 0!==o&&"false"!=o&&""!=o||(o=0),void 0!==a&&"false"!=a&&""!=a||(a=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",r).text(),item_type:"tags",is_dropdown:!0,maxtags:jQuery(".ZP_MAXTAGS",r).text(),request_start:o,request_last:a,update:s,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(o){if(!o||""===o.trim())return console.log("zp: Empty tags response received"),void jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove();var a;try{a=jQuery.parseJSON(o)}catch(e){return console.log("zp: Tags JSON parsing error:",e),console.log("zp: Raw tags response data:",o),void jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove()}if("error"===a.status)return console.log("zp: Server returned error:",a.data),void jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove();if("empty"===a.status)return console.log("zp: No tags found"),jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove(),void jQuery("select.zp-List-Tags",r).append("<option rel='empty' value='empty'>"+zpShortcodeAJAX.txt_notags+"</option>");var n="<option class='zp-List-Tags-Select' name='zp-List-Tags-Select'>--"+zpShortcodeAJAX.txt_notagsel+"--</option>\n";t.zpTagId&&(n="<option value='toplevel' class='toplevel'>--"+zpShortcodeAJAX.txt_unsettag+"--</option>\n"),!1===s&&jQuery("select.zp-List-Tags",r).addClass("used_cache"),!0!==s||jQuery("select.zp-List-Tags",r).hasClass("updating")||jQuery("select.zp-List-Tags",r).empty().addClass("updating"),0!==a&&a.data&&Array.isArray(a.data)&&a.data.length>0?(jQuery.each(a.data,function(e,t){var o="<option class='zp-List-Tag' value='"+t.tag.replace(/ /g,"+")+"'";jQuery(".ZP_TAG_ID",r).length>0&&jQuery(".ZP_TAG_ID",r).text()==t.tag&&(o+=" selected='selected'"),o+=">"+t.tag+" ("+t.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",n+=o}),jQuery("select.zp-List-Tags",r).append(n),0!=a.meta.request_next&&"false"!=a.meta.request_next?l(e,t,r,a.meta.request_next,a.meta.request_last,s):jQuery("select.zp-List-Tags",r).hasClass("updating")||l(e,t,r,0,0,!0),jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove()):(jQuery("select.zp-List-Tags",r).removeClass("loading").find(".loading").remove(),jQuery("select.zp-List-Tags",r).append("<option rel='empty' value='empty'>"+zpShortcodeAJAX.txt_notags+"</option>"))},error:function(e){console.log("zp: error for zplib_get_tags(): ",e.statusText)},complete:function(e,t){}})}function n(e,t,o,s,l,i){console.log("zp: calling zplib_get_items with update check?",i),console.log("zp: is an update needed?",r),void 0!==s&&"false"!=s&&""!=s||(s=0),void 0!==l&&"false"!=l&&""!=l||(l=0),jQuery(".zp-List",o).hasClass("loading")&&""==jQuery(".zp-List",o).find(".zp_display_progress").text()&&jQuery(".zp-List",o).append("<div class='zp_display_progress'>"+zpShortcodeAJAX.txt_loading+" ...</div>"),jQuery.ajax({async:!0,url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",o).text(),is_dropdown:!0,item_type:"items",citeable:jQuery(".ZP_CITEABLE",o).text(),downloadable:jQuery(".ZP_DOWNLOADABLE",o).text(),showtags:t.zpShowTags,showimage:t.zpShowImages,target:t.zpTarget,urlwrap:t.zpURLWrap,collection_id:t.zpCollectionId,tag_id:t.zpTagId,get_top:!0,sortby:jQuery(".ZP_SORTBY",o).text(),order:jQuery(".ZP_ORDER",o).text(),update:i,request_update:r,request_start:s,request_last:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(s){if(!s||""===s.trim())return console.log("zp: Empty response received"),jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),void jQuery(".zpSearchResultsContainer",o).append("<p>No data received from server</p>\n");var l;try{l=jQuery.parseJSON(s)}catch(e){return console.log("zp: JSON parsing error:",e),console.log("zp: Raw response data:",s),console.log("zp: Response length:",s.length),console.log("zp: Response preview:",s.substring(0,200)+"..."),jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),void jQuery(".zpSearchResultsContainer",o).append("<p>Error loading items: Invalid response from server</p>\n")}if("error"===l.status)return console.log("zp: Server returned error:",l.data),jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),void jQuery(".zpSearchResultsContainer",o).append("<p>Error: "+l.data+"</p>\n");if("empty"===l.status)return console.log("zp: No items found"),jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),void jQuery(".zpSearchResultsContainer",o).append("<p>No items found</p>\n");if(l.data&&Array.isArray(l.data)&&jQuery.each(l.data,function(e,t){var r=(new DOMParser).parseFromString(t.bib,"text/html");l.data[e].bib=r.documentElement.textContent}),!1===i?jQuery(".zp-List",o).addClass("used_cache"):!0===i&&(jQuery(".zp-List",o).hasClass("updating")||jQuery(".zp-List",o).addClass("updating")),void 0!==l&&null!=l&&0!=l&&l.data.length>0&&0!=l.data){var p="";if(jQuery(".zp-List",o).hasClass("updating")||!1===l.meta.request_last||"false"==l.meta.request_last||0===l.meta.request_last||jQuery(".zp-List",o).find(".zp_display_progress").html("Loading "+l.meta.request_next+"-"+(l.meta.request_next+50)+" out of "+(parseInt(l.meta.request_last)+50)+"..."),0!=l.data&&jQuery.each(l.data,function(e,r){var a="",s=jQuery("div.zp-List .zp-ID-"+r.library.id+"-"+r.key,o),l="0000";r.meta.hasOwnProperty("parsedDate")&&(l=r.meta.parsedDate.substring(0,4));var n=r.data.title;r.meta.hasOwnProperty("creatorSummary")&&(n=r.meta.creatorSummary.replace(/ /g,"-")),a+="<div id='zp-ID-"+r.library.id+"-"+r.key+"' class='zp-Entry zpSearchResultsItem hidden",!0===i&&(a+=" zp_updated"),a+="' data-zp-author-year='"+n+"-"+l+"'",a+="' data-zp-year-author='"+l+"-"+n+"'",a+=">\n",(t.zpIsAdmin||t.zpShowImages&&r.hasOwnProperty("image"))&&(a+="<div id='zp-Citation-"+r.key+"' class='zp-Entry-Image",r.hasOwnProperty("image")&&(a+=" hasImage"),a+="' rel='"+r.key+"'>\n",r.hasOwnProperty("image")&&(a+="<img class='thumb' src='"+r.image[0]+"' alt='image' />\n"),t.zpIsAdmin&&(r.hasOwnProperty("image")?a+="<a title='Change Image' class='upload' rel='"+r.key+"' href='#'>"+zpShortcodeAJAX.txt_changeimg+"</a>\n":a+="<a title='Set Image' class='upload' rel='"+r.key+"' href='#'>"+zpShortcodeAJAX.txt_setimg+"</a>\n"),t.zpIsAdmin&&r.hasOwnProperty("image")&&(a+="<a title='"+zpShortcodeAJAX.txt_removeimg+"' class='delete' rel='"+r.key+"' href='#'>&times;</a>\n"),a+="</div>\x3c!-- .zp-Entry-Image --\x3e\n"),a+=r.bib,t.zpShowTags&&r.data.tags.length>0&&(a+="<span class='item_key'>Tag(s): ",jQuery.each(r.data.tags,function(e,t){0!=e&&(a+=", "),a+=t.tag})),t.zpIsAdmin&&(a+="<label for='item_key'>"+zpShortcodeAJAX.txt_itemkey+":</label><input type='text' name='item_key' class='item_key' value='"+r.key+"'>\n"),a+="</div>\x3c!-- .zp-Entry --\x3e\n",s.length>0&&!0===i?s.replaceWith(jQuery(a)):p+=a}),!1===i&&jQuery(".zpSearchResultsContainer",o).append(p),0!=l.meta.request_next&&"false"!=l.meta.request_next)1==t.zpItemsFlag?window.zpBrowseList[e].paginate(t.zpItemsFlag,!1):window.zpBrowseList[e].paginate(t.zpItemsFlag,!0),t.zpItemsFlag=!1,a(o),n(e,t,o,l.meta.request_next,l.meta.request_last,i);else if(window.zpBrowseList[e].paginate(t.zpItemsFlag),t.zpItemsFlag=!1,jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),l.updateneeded)console.log("zp: update needed"),r=!0,n(e,t,o,0,0,!0);else{r=!1;var d=jQuery(".ZP_SORTBY",o).text(),u=jQuery(".ZP_ORDER",o).text();if(-1!==["author","date"].indexOf(d)&&0==jQuery("div.zp-List .csl-left-margin",o).length){var c="data-zp-author-year";"date"==d&&(c="data-zp-year-author"),jQuery("#"+l.instance+" .zp-List div.zp-Entry",o).sort(function(e,t){var r=e.getAttribute(c).toLowerCase(),o=t.getAttribute(c).toLowerCase();return r>o?"asc"==u?1:-1:r<o?"asc"==u?-1:1:0}).detach().appendTo("#"+l.instance+" .zp-List",o)}a(o)}}else jQuery(".zp-List",o).removeClass("loading"),jQuery(".zp-List",o).find(".zp_display_progress").remove(),jQuery(".zpSearchResultsContainer",o).append("<p>"+zpShortcodeAJAX.txt_nocitations+"</p>\n")},error:function(e){console.log("Error for zplib_get_items(): ",e.statusText)}})}});